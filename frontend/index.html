<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AI E-Learn — Personalized Roadmaps</title>
  <!-- Tailwind CDN (Play CDN for quick prototypes) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    // Tailwind config for custom colors (optional)
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#0f172a',
            accent: '#06b6d4'
          }
        }
      }
    }
  </script>
  <style>
    /* small extra styles */
    html,body,#app { height: 100%; }
    .glass { background: rgba(255,255,255,0.04); backdrop-filter: blur(6px); }
    pre { white-space: pre-wrap; word-break: break-word; }
  </style>
</head>
<body class="bg-gradient-to-br from-slate-900 via-slate-800 to-indigo-900 text-slate-100">
  <div id="app" class="min-h-screen flex flex-col">
    <!-- top nav -->
    <nav class="flex items-center justify-between px-6 py-4">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-lg bg-gradient-to-tr from-accent to-indigo-500 flex items-center justify-center shadow-lg">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-black" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6l4 2" />
          </svg>
        </div>
        <span class="font-semibold text-lg">AI E-Learn</span>
      </div>
      <div class="flex items-center gap-3">
        <a href="#/" class="nav-link px-3 py-2 rounded hover:bg-white/5">Home</a>
        <a href="#/quiz" class="nav-link px-3 py-2 rounded hover:bg-white/5">Take Quiz</a>
        <a href="#/dashboard" class="nav-link px-3 py-2 rounded hover:bg-white/5">Dashboard</a>
        <button id="nav-auth" class="ml-2 px-4 py-2 rounded bg-accent text-slate-900 font-semibold hover:brightness-110">Login</button>
      </div>
    </nav>

    <!-- main content container -->
    <main id="main" class="flex-1 px-6 py-8 max-w-6xl mx-auto w-full"></main>

    <footer class="text-center text-sm text-slate-400 py-6">© <span id="year"></span> AI E-Learn — Built with ❤️ & Tailwind</footer>
  </div>

<script>
/* Single-file SPA that contains:
   - Landing page
   - Login / Register
   - Quiz (uses embedded QUESTIONS)
   - Results & Roadmap view
   - Dashboard

   It talks to the backend endpoints provided by your FastAPI app:
     POST /api/register
     POST /api/login
     POST /api/submit (Authorization: Bearer <token>)
     POST /api/feedback (Authorization)
     GET  /api/dashboard (Authorization)
*/

// Embedded QUESTIONS same as backend
const QUESTIONS = [
    { "question": "Which of the following best describes a 'for' loop?",
      "options": ["A conditional statement", "A way to store multiple values", "A control flow statement for iterating", "A function that calls itself"],
      "scores": [2,3,10,1]},
    { "question": "How would you efficiently create a new list of only even numbers from an existing list?",
      "options": ["Series of 'if-else' statements", "A loop that checks each number", "A function for every possible number", "Store numbers in separate variables"],
      "scores": [3,10,1,2]},
    { "question": "What is the primary purpose of a function in programming?",
      "options": ["To stop the program", "To store data", "To group reusable code", "To create comments"],
      "scores": [1,3,10,2]},
    { "question": "If a coin is flipped twice, what is the probability of getting two heads?",
      "options": ["1/2", "1/3", "1/4", "1"],
      "scores": [3,2,10,1]},
    { "question": "What does the 'mean' of a dataset represent?",
      "options": ["The middle value", "The most frequent value", "The average of all values", "The range of values"],
      "scores": [4,3,10,2]},
    { "question": "An upward trend in a graph where both variables increase together is called:",
      "options": ["Negative correlation", "Positive correlation", "No correlation", "A statistical error"],
      "scores": [1,10,2,1]},
    { "question": "What is the role of a server in a client-server relationship?",
      "options": ["To request information", "To provide resources or services", "The user's main computer", "To protect from viruses"],
      "scores": [3,10,2,4]},
    { "question": "Which of the following best describes 'the cloud'?",
      "options": ["A single, massive computer", "A network of servers accessed via internet", "A personal storage device", "Software for documents"],
      "scores": [2,10,1,1]},
    { "question": "What is an API (Application Programming Interface)?",
      "options": ["A visual user interface", "A set of rules for app communication", "A database for storage", "A security protocol"],
      "scores": [3,10,2,4]},
    { "question": "When designing a website, what is the most important consideration?",
      "options": ["Using many colors", "Intuitive user navigation", "Complex animations", "Smallest font size"],
      "scores": [2,10,1,1]},
    { "question": "What's the best way to create visual hierarchy on a poster?",
      "options": ["Make all text the same", "Make important info larger/bolder", "Put least important info at top", "Fill every empty space"],
      "scores": [1,10,1,2]},
    { "question": "What is the primary goal of UX (User Experience) design?",
      "options": ["Making a product look appealing", "Focusing on branding/logo", "Enhancing usability and accessibility", "Writing the application code"],
      "scores": [4,2,10,1]},
    { "question": "What's a constructive way to handle disagreement with a teammate?",
      "options": ["Ignore their idea", "Publicly criticize them", "Discuss pros and cons together", "Complain to someone else"],
      "scores": [1,1,10,1]},
    { "question": "What is the main purpose of version control software like Git?",
      "options": ["To write code automatically", "To track changes and manage collaboration", "To design the UI", "To store only the final version"],
      "scores": [1,10,1,2]},
    { "question": "When presenting to stakeholders, it's most important to:",
      "options": ["Use highly technical jargon", "Focus only on what went wrong", "Clearly communicate progress and challenges", "Make the presentation as long as possible"],
      "scores": [1,1,10,1]}
];

// small helpers
const el = (sel) => document.querySelector(sel);
const api = (path, opts={}) => fetch(path, opts);
const setYear = () => el('#year').textContent = new Date().getFullYear();
setYear();

// Router
function route() {
  const hash = location.hash.replace('#','') || '/';
  if (hash.startsWith('/login')) return renderLogin();
  if (hash.startsWith('/quiz')) return renderQuiz();
  if (hash.startsWith('/dashboard')) return renderDashboard();
  return renderLanding();
}
window.addEventListener('hashchange', route);

// nav auth button
function updateNavAuth() {
  const token = localStorage.getItem('token');
  const btn = el('#nav-auth');
  if (token) {
    btn.textContent = 'Dashboard';
    btn.onclick = () => location.hash = '#/dashboard';
  } else {
    btn.textContent = 'Login';
    btn.onclick = () => location.hash = '#/login';
  }
}
updateNavAuth();

// Nice UI components
function makeCard(title, bodyHtml=''){
  return `
    <div class="bg-white/5 border border-white/5 rounded-xl p-6 shadow-lg">
      <h3 class="text-xl font-semibold mb-2">${title}</h3>
      <div class="text-slate-300 text-sm">${bodyHtml}</div>
    </div>
  `;
}

// ---------- Landing ----------
function renderLanding(){
  updateNavAuth();
  const main = el('#main');
  main.innerHTML = `
    <section class="grid md:grid-cols-2 gap-8 items-center">
      <div>
        <h1 class="text-4xl font-extrabold leading-tight">AI-powered learning roadmaps<br/><span class="text-accent">Personalized</span> for every learner</h1>
        <p class="mt-4 text-slate-300">Take a quick skills assessment and get a 6-week AI-generated roadmap, practice tasks, and curated resources. Track progress on your dashboard.</p>
        <div class="mt-6 flex gap-3">
          <a href="#/quiz" class="inline-block px-6 py-3 bg-accent text-slate-900 rounded-lg font-semibold shadow hover:scale-105 transition">Take the Quiz</a>
          <a href="#/login" class="inline-block px-6 py-3 border border-white/10 rounded-lg text-slate-100 hover:bg-white/5 transition">Login / Register</a>
        </div>
        <div class="mt-8 grid grid-cols-2 gap-3">
          ${makeCard('Fast results', '15 questions — finish in ~5 minutes and get a tailored plan.')}
          ${makeCard('AI-generated', 'Gemini-powered prompts (or a heuristic fallback for offline use).')}
        </div>
      </div>
      <div class="p-6">
        <div class="rounded-2xl bg-gradient-to-br from-white/5 to-white/3 p-6 glass">
          <h4 class="text-lg font-semibold">Sample Roadmap Preview</h4>
          <ol class="mt-3 text-sm text-slate-300 space-y-2">
            <li><strong>Week 1:</strong> Refresh loops & functions — 20 min daily tasks.</li>
            <li><strong>Week 2:</strong> Data structures — hands-on list/dict practice.</li>
            <li><strong>Week 3:</strong> Probability basics — small exercises.</li>
          </ol>
        </div>
      </div>
    </section>

    <section class="mt-12">
      <h2 class="text-2xl font-semibold">Why AI E-Learn?</h2>
      <div class="mt-6 grid md:grid-cols-3 gap-6">
        <div class="p-6 bg-white/5 rounded-lg"> <h3 class="font-semibold">Personalized</h3><p class="text-sm text-slate-300 mt-2">Roadmaps adapt to your answers and strengths.</p></div>
        <div class="p-6 bg-white/5 rounded-lg"> <h3 class="font-semibold">Practical</h3><p class="text-sm text-slate-300 mt-2">Real tasks, not just theory.</p></div>
        <div class="p-6 bg-white/5 rounded-lg"> <h3 class="font-semibold">Trackable</h3><p class="text-sm text-slate-300 mt-2">Dashboard keeps your attempts and feedback.</p></div>
      </div>
    </section>
  `;
}

// ---------- Login / Register ----------
function renderLogin(){
  updateNavAuth();
  const main = el('#main');
  main.innerHTML = `
    <div class="max-w-2xl mx-auto bg-white/5 rounded-2xl p-8">
      <h2 class="text-2xl font-semibold mb-4">Sign in or create an account</h2>
      <div class="grid md:grid-cols-2 gap-4">
        <div>
          <h4 class="font-semibold">Register</h4>
          <input id="reg_name" class="mt-2 w-full p-3 rounded bg-white/3" placeholder="Full name" />
          <input id="reg_email" class="mt-2 w-full p-3 rounded bg-white/3" placeholder="Email" />
          <input id="reg_pass" type="password" maxlength="72" class="mt-2 w-full p-3 rounded bg-white/3" placeholder="Password" />
          <button id="reg_btn" class="mt-3 px-4 py-2 bg-accent rounded font-semibold text-slate-900">Create account</button>
        </div>
        <div>
          <h4 class="font-semibold">Login</h4>
          <input id="log_email" class="mt-2 w-full p-3 rounded bg-white/3" placeholder="Email" />
          <input id="log_pass" type="password" maxlength="72" class="mt-2 w-full p-3 rounded bg-white/3" placeholder="Password" />
          <button id="log_btn" class="mt-3 px-4 py-2 bg-white/6 rounded font-semibold">Sign in</button>
        </div>
      </div>
      <div id="auth-msg" class="mt-3 text-sm text-rose-400"></div>
    </div>
  `;

  // handlers
  el('#reg_btn').addEventListener('click', async ()=>{
    const name = el('#reg_name').value.trim();
    const email = el('#reg_email').value.trim();
    const pass = el('#reg_pass').value;
    if (!name||!email||!pass){ el('#auth-msg').textContent = 'Fill all fields to register.'; return; }
    try {
      const res = await fetch('/api/register', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({name, email, password: pass}) });
      const data = await res.json();
      if (!res.ok) { el('#auth-msg').textContent = data.detail || JSON.stringify(data); return; }
      localStorage.setItem('token', data.access_token);
      updateNavAuth();
      location.hash = '#/quiz';
    } catch (e){ el('#auth-msg').textContent = 'Network error'; }
  });

  el('#log_btn').addEventListener('click', async ()=>{
    const email = el('#log_email').value.trim();
    const pass = el('#log_pass').value;
    if (!email||!pass){ el('#auth-msg').textContent = 'Fill email & password.'; return; }
    try {
      const res = await fetch('/api/login', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({email, password: pass}) });
      const data = await res.json();
      if (!res.ok) { el('#auth-msg').textContent = data.detail || JSON.stringify(data); return; }
      localStorage.setItem('token', data.access_token);
      updateNavAuth();
      location.hash = '#/quiz';
    } catch (e){ el('#auth-msg').textContent = 'Network error'; }
  });
}

// ---------- Quiz ----------
function renderQuiz(){
  updateNavAuth();
  const main = el('#main');
  // build quiz
  let html = `
    <div class="max-w-4xl mx-auto bg-white/5 rounded-2xl p-6">
      <div class="flex items-center justify-between">
        <h2 class="text-2xl font-semibold">Skills Assessment</h2>
        <div class="text-sm text-slate-300">15 questions — ~5 minutes</div>
      </div>
      <form id="quiz-form" class="mt-4 space-y-4">
  `;
  QUESTIONS.forEach((q,i)=>{
    html += `
      <div class="p-4 bg-white/3 rounded-lg">
        <div class="font-medium">Q${i+1}. ${q.question}</div>
        <div class="mt-2 grid md:grid-cols-2 gap-2">
    `;
    q.options.forEach((opt,j)=>{
      html += `
        <label class="p-2 rounded border border-white/5 cursor-pointer hover:bg-white/5 flex items-center gap-3">
          <input type="radio" name="q${i}" value="${j}" />
          <span>${opt}</span>
        </label>
      `;
    });
    html += `</div></div>`;
  });
  html += `
      <div class="flex items-center gap-3 mt-4">
        <button id="submitQuiz" type="button" class="px-5 py-3 bg-accent text-slate-900 rounded font-semibold">Submit & Get Roadmap</button>
        <button id="resetQuiz" type="button" class="px-4 py-2 border rounded">Reset</button>
        <div id="quiz-msg" class="text-sm text-rose-400 ml-4"></div>
      </div>
      </form>
    </div>
  `;
  main.innerHTML = html;

  el('#resetQuiz').addEventListener('click', ()=>{ document.getElementById('quiz-form').reset(); });

  el('#submitQuiz').addEventListener('click', async ()=>{
    const token = localStorage.getItem('token');
    if(!token){
      location.hash = '#/login';
      return;
    }

    const answers = [];
    let missing = false;

    for(let i=0;i<QUESTIONS.length;i++){
      const selected = document.querySelector(`input[name=q${i}]:checked`);
      if(!selected){
        missing = true;
        break;
      }
      answers.push(parseInt(selected.value));
    }

    if(missing){
      el('#quiz-msg').textContent = '⚠ Please answer all questions before submitting.';
      return;
    }

    el('#quiz-msg').textContent = 'Submitting...';

    try{
      const res = await fetch('/api/submit', {
        method: 'POST',
        headers: {
          'Content-Type':'application/json',
          'Authorization': 'Bearer ' + token
        },
        body: JSON.stringify({ answers })
      });

      const text = await res.text();
      let data;
      try { data = JSON.parse(text); }
      catch(e){ throw new Error('Server error: ' + text); }

      if(!res.ok) throw new Error(data.detail || JSON.stringify(data));

      renderResults(data);

    } catch(err){
      el('#quiz-msg').textContent = err.message || 'Submission failed.';
    }
  });
}

// ---------- Results & Roadmap ----------
function renderResults(data){
  updateNavAuth();
  const main = el('#main');
  let html = `
    <div class="max-w-4xl mx-auto space-y-6">
      <div class="p-6 rounded-xl bg-white/5">
        <h2 class="text-2xl font-semibold">Your Results</h2>
        <p class="text-slate-300 mt-2">Total score: <strong class="text-accent">${data.total_score}</strong></p>
      </div>
      <div class="grid md:grid-cols-2 gap-6">
        <div class="p-6 rounded-xl bg-white/5">
          <h3 class="font-semibold">Per-question feedback</h3>
          <div class="mt-3 space-y-3 text-sm text-slate-200">
  `;
  data.per_question.forEach((pq, idx)=>{
    html += `<div class="p-3 rounded border border-white/5 ${pq.is_correct? 'bg-green-900/10':'bg-rose-900/8'}">
        <div class="font-medium">Q${idx+1}. ${pq.question}</div>
        <div class="text-sm mt-1">You chose: <strong>${pq.chosen_text}</strong> (${pq.score_for_choice})</div>
        <div class="text-sm">Correct answer: <strong>${pq.correct_text}</strong></div>
      </div>`;
  });
  html += `</div></div>`;

  // roadmap column
  html += `
    <div class="p-6 rounded-xl bg-white/5">
      <h3 class="font-semibold">AI-generated roadmap</h3>
      <div class="mt-3 text-sm text-slate-200">
        <pre id="roadmap-pre">${JSON.stringify(data.roadmap, null, 2)}</pre>
      </div>
      <div class="mt-4 flex gap-3">
        <button id="saveFeedback" class="px-4 py-2 bg-accent text-slate-900 rounded font-semibold">Give Feedback</button>
        <button id="toDashboard" class="px-4 py-2 border rounded">Go to Dashboard</button>
      </div>
    </div>`;

  html += `</div></div>`;
  main.innerHTML = html;

  el('#toDashboard').addEventListener('click', ()=> location.hash = '#/dashboard');
  el('#saveFeedback').addEventListener('click', ()=> showFeedbackForm(data.result_id));
}

function showFeedbackForm(result_id){
  // modal-like simple prompt
  const container = document.createElement('div');
  container.className = 'fixed inset-0 flex items-center justify-center z-50';
  container.innerHTML = `
    <div class="bg-black/60 absolute inset-0"></div>
    <div class="relative bg-white/5 p-6 rounded-xl w-[90%] max-w-md">
      <h4 class="font-semibold">Rate this roadmap</h4>
      <div class="mt-3">
        <label class="block text-sm">Rating (1-5)</label>
        <input id="fb_rate_modal" type="number" min="1" max="5" value="5" class="w-full p-2 rounded bg-white/3 mt-1" />
      </div>
      <div class="mt-3">
        <label class="block text-sm">Comment</label>
        <textarea id="fb_comment_modal" class="w-full p-2 rounded bg-white/3 mt-1"></textarea>
      </div>
      <div class="mt-4 flex justify-end gap-2">
        <button id="fb_cancel" class="px-4 py-2 border rounded">Cancel</button>
        <button id="fb_send" class="px-4 py-2 bg-accent text-slate-900 rounded font-semibold">Send</button>
      </div>
    </div>
  `;
  document.body.appendChild(container);
  container.querySelector('#fb_cancel').addEventListener('click', ()=> container.remove());
  container.querySelector('#fb_send').addEventListener('click', async ()=>{
    const rating = parseInt(container.querySelector('#fb_rate_modal').value || '5');
    const comment = container.querySelector('#fb_comment_modal').value || '';
    const token = localStorage.getItem('token');
    try {
      const res = await fetch('/api/feedback', { method:'POST', headers: { 'Content-Type':'application/json', 'Authorization': 'Bearer '+token }, body: JSON.stringify({result_id, rating, comment}) });
      const data = await res.json();
      if (!res.ok) throw new Error(data.detail || JSON.stringify(data));
      alert('Thanks for the feedback!');
      container.remove();
    } catch (err){ alert('Feedback failed: '+ (err.message||err)); }
  });
}

// ---------- Dashboard ----------
async function renderDashboard(){
  updateNavAuth();
  const main = el('#main');
  main.innerHTML = `<div class="flex items-center justify-center py-10"><div class="text-slate-400">Loading dashboard...</div></div>`;
  const token = localStorage.getItem('token');
  if (!token){ location.hash = '#/login'; return; }
  try {
    const res = await fetch('/api/dashboard', { headers: { 'Authorization': 'Bearer '+token } });
    const data = await res.json();
    if (!res.ok) { throw new Error(data.detail || JSON.stringify(data)); }
    // render
    let html = `
      <div class="max-w-5xl mx-auto space-y-6">
        <div class="p-6 rounded-xl bg-white/5 flex items-center justify-between">
          <div>
            <h3 class="font-semibold text-lg">Welcome, ${data.user.name}</h3>
            <div class="text-sm text-slate-300">${data.user.email}</div>
          </div>
          <div>
            <button id="logoutBtn" class="px-4 py-2 border rounded">Logout</button>
          </div>
        </div>
        <div class="grid md:grid-cols-2 gap-6">
          <div class="p-6 bg-white/5 rounded-xl">
            <h4 class="font-semibold">Recent attempts</h4>
            <div class="mt-3 space-y-3">
              ${data.results.length? data.results.map(r => `
                <div class="p-3 rounded border border-white/5">
                  <div class="text-sm text-slate-300">${r.created_at}</div>
                  <div class="font-medium">Score: <span class="text-accent">${r.score}</span></div>
                  <details class="mt-2 text-sm"><summary class="cursor-pointer">View roadmap</summary>
                    <pre class="mt-2 text-xs text-slate-200 p-2 rounded bg-black/20">${escapeHtml(JSON.stringify(r.roadmap, null, 2))}</pre>
                  </details>
                </div>
              `).join('') : '<div class="text-sm text-slate-400">No attempts yet.</div>'}
            </div>
          </div>
          <div class="p-6 bg-white/5 rounded-xl">
            <h4 class="font-semibold">Feedback you gave</h4>
            <div class="mt-3 space-y-3">
              ${data.feedbacks.length? data.feedbacks.map(f => `
                <div class="p-3 rounded border border-white/5">
                  <div class="text-sm text-slate-300">${f.created_at}</div>
                  <div>Rating: <strong>${f.rating}</strong></div>
                  <div class="text-sm mt-1">${f.comment||''}</div>
                </div>
              `).join('') : '<div class="text-sm text-slate-400">No feedback yet.</div>'}
            </div>
          </div>
        </div>
      </div>
    `;
    main.innerHTML = html;
    el('#logoutBtn').addEventListener('click', ()=>{ localStorage.removeItem('token'); updateNavAuth(); location.hash = '#/'; });
  } catch (err) {
    main.innerHTML = `<div class="text-rose-400">Could not load dashboard: ${err.message||err}</div>`;
  }
}

// small util to safely escape HTML for showing JSON inside pre
function escapeHtml(str){ return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

// initial route
route();
</script>
</body>
</html>
